<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mapa de Universidades de MÃ©xico</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <!-- Google Fonts para el tÃ­tulo -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            font-family: 'Roboto', Arial, sans-serif;
            background: linear-gradient(135deg, #3a6186 0%, #89253e 100%);
            min-height: 100vh;
        }
        header {
            text-align: center;
            color: #fff;
            padding: 2rem 1rem 1rem 1rem;
        }
        header h1 {
            font-family: 'Montserrat', Arial, sans-serif;
            font-size: 2.2rem;
            margin: 0;
            letter-spacing: 1px;
            text-shadow: 0 2px 8px #0007;
        }
        header p {
            font-size: 1.1rem;
            color: #f3e8ff;
            margin-top: 0.5rem;
        }
        #map {
            width: 90vw;
            height: 80vh;
            max-width: 1200px;
            margin: 2rem auto;
            border-radius: 18px;
            box-shadow: 0 6px 30px #0008;
            border: 3px solid #fff;
        }
        #loader {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 1.3rem;
            font-family: 'Montserrat', Arial, sans-serif;
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 1000;
            background: rgba(34, 34, 34, 0.7);
        }
        @media (max-width: 900px) {
            #map { width: 98vw; height: 70vh; }
        }
    </style>
</head>
<body>
    <header>
        <h1>ðŸ‡²ðŸ‡½ Universidades de MÃ©xico</h1>
        <p>Mapa interactivo de universidades mexicanas usando datos en tiempo real.<br>
        <small>(La carga inicial puede tardar unos segundos, Â¡gracias por tu paciencia!)</small></p>
    </header>
    <div id="map"></div>
    <div id="loader" style="display:none;">Cargando universidades de MÃ©xico...</div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        const loader = document.getElementById('loader');
        loader.style.display = 'flex';

        // Inicializa el mapa centrado en MÃ©xico
        var map = L.map('map').setView([23.6345, -102.5528], 5.2);

        // AÃ±ade capa base
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // Icono personalizado para universidades
        var universityIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/190/190411.png',
            iconSize: [30, 30],
            iconAnchor: [15, 30],
            popupAnchor: [0, -28]
        });

        // Obtener universidades desde la API Hipolabs
        async function fetchUniversitiesMX() {
            const res = await fetch('https://universities.hipolabs.com/search?country=Mexico');
            return await res.json();
        }

        // Geocodifica el nombre de la universidad + paÃ­s usando Nominatim (OpenStreetMap)
        async function geocodeUniversity(university) {
            // Nominatim limita el uso, asÃ­ que agregamos ciudad si estÃ¡ disponible y pausas entre requests
            const query = encodeURIComponent(`${university.name}, ${university['state-province'] ? university['state-province'] + ', ' : ''}Mexico`);
            const url = `https://nominatim.openstreetmap.org/search?q=${query}&format=json&limit=1`;
            try {
                const res = await fetch(url, {
                    headers: {
                        'Accept-Language': 'es,en;q=0.9'
                    }
                });
                const data = await res.json();
                if (data.length > 0)
                    return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
                else
                    return null;
            } catch (err) {
                return null;
            }
        }

        // Duerme (ms) para evitar rate limits
        function sleep(ms) { return new Promise(res => setTimeout(res, ms)); }

        async function main() {
            const universities = await fetchUniversitiesMX();
            const markers = [];
            // Nominatim recomienda max 1 request por segundo
            let count = 0;
            for (let uni of universities) {
                loader.innerText = `Geolocalizando: ${uni.name} (${++count}/${universities.length})`;
                let coords = await geocodeUniversity(uni);
                if (!coords) {
                    // Intenta solo con el nombre y MÃ©xico si la bÃºsqueda con estado falla
                    coords = await geocodeUniversity({name: uni.name});
                }
                if (coords) {
                    const marker = L.marker([coords.lat, coords.lon], {icon: universityIcon})
                        .addTo(map)
                        .bindPopup(`
                            <strong>${uni.name}</strong><br>
                            <em>${uni['state-province'] ? uni['state-province'] + ', ' : ''}MÃ©xico</em><br>
                            <a href="${uni.web_pages[0]}" target="_blank" rel="noopener noreferrer">Sitio web</a>
                        `);
                    markers.push(marker);
                }
                // Espera 1100ms para evitar bloqueo de Nominatim
                await sleep(1100);
            }
            loader.style.display = 'none';
            if (markers.length > 1) {
                var group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        main();
    </script>
</body>
</html>
