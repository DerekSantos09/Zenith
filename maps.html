<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mapa de Universidades de MÃ©xico</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            font-family: 'Roboto', Arial, sans-serif;
            background: linear-gradient(135deg, #3a6186 0%, #89253e 100%);
            min-height: 100vh;
        }
        header {
            text-align: center;
            color: #fff;
            padding: 2rem 1rem 1rem 1rem;
        }
        header h1 {
            font-family: 'Montserrat', Arial, sans-serif;
            font-size: 2.2rem;
            margin: 0;
            letter-spacing: 1px;
            text-shadow: 0 2px 8px #0007;
        }
        header p {
            font-size: 1.1rem;
            color: #f3e8ff;
            margin-top: 0.5rem;
        }
        #search-container {
            display: flex;
            justify-content: center;
            margin: 1rem auto 0 auto;
        }
        #search {
            width: 350px;
            max-width: 98vw;
            font-size: 1rem;
            padding: 0.7rem 1rem;
            border-radius: 18px;
            border: none;
            box-shadow: 0 2px 8px #0002;
        }
        #map {
            width: 90vw;
            height: 78vh;
            max-width: 1200px;
            margin: 1.5rem auto 2rem auto;
            border-radius: 18px;
            box-shadow: 0 6px 30px #0008;
            border: 3px solid #fff;
            position: relative;
            z-index: 1;
        }
        #loader {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 1.3rem;
            font-family: 'Montserrat', Arial, sans-serif;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 1000;
            background: rgba(34, 34, 34, 0.92);
        }
        @media (max-width: 900px) {
            #map { width: 98vw; height: 60vh; }
            #search { width: 98vw; }
        }
        .leaflet-popup-content {
            font-size: 1.06rem;
        }
    </style>
</head>
<body>
    <header>
        <h1>ðŸ‡²ðŸ‡½ Universidades de MÃ©xico</h1>
        <p>
            Mapa interactivo de universidades mexicanas en tiempo real.<br>
            <small>(La primera carga puede tardar unos minutos. Usando cachÃ© para mÃ¡s velocidad la prÃ³xima vez.)</small>
        </p>
    </header>
    <div id="search-container">
        <input type="text" id="search" placeholder="ðŸ”Ž Busca universidad o estado...">
    </div>
    <div id="map"></div>
    <div id="loader" style="display:none;">Cargando universidades de MÃ©xico...</div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        const loader = document.getElementById('loader');
        const searchInput = document.getElementById('search');
        let allUniversities = [];
        let allMarkers = [];

        // Inicializa el mapa centrado en MÃ©xico
        var map = L.map('map').setView([23.6345, -102.5528], 5.2);

        // AÃ±ade capa base
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // Icono personalizado para universidades
        var universityIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/190/190411.png',
            iconSize: [30, 30],
            iconAnchor: [15, 30],
            popupAnchor: [0, -28]
        });

        async function fetchUniversitiesMX() {
            const res = await fetch('https://universities.hipolabs.com/search?country=Mexico');
            return await res.json();
        }

        async function geocodeUniversity(university) {
            const query = encodeURIComponent(`${university.name}, ${university['state-province'] ? university['state-province'] + ', ' : ''}Mexico`);
            const url = `https://nominatim.openstreetmap.org/search?q=${query}&format=json&limit=1`;
            try {
                const res = await fetch(url, {
                    headers: {'Accept-Language': 'es,en;q=0.9'}
                });
                const data = await res.json();
                if (data.length > 0)
                    return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
                else
                    return null;
            } catch (err) {
                return null;
            }
        }

        function sleep(ms) { return new Promise(res => setTimeout(res, ms)); }

        function saveCache(data) {
            localStorage.setItem('universidades-mx', JSON.stringify(data));
            localStorage.setItem('universidades-mx-date', new Date().toISOString());
        }
        function loadCache() {
            const data = localStorage.getItem('universidades-mx');
            return data ? JSON.parse(data) : [];
        }
        function cacheFresh() {
            const date = localStorage.getItem('universidades-mx-date');
            if (!date) return false;
            // VÃ¡lido por 15 dÃ­as
            return (new Date() - new Date(date)) < 15 * 24 * 60 * 60 * 1000;
        }

        // Filtra universidades y actualiza marcadores
        function filterAndShowMarkers(query) {
            const q = query.trim().toLowerCase();
            const filtered = !q
                ? allUniversities
                : allUniversities.filter(u =>
                    u.name.toLowerCase().includes(q) ||
                    (u['state-province'] && u['state-province'].toLowerCase().includes(q))
                );
            // Limpia marcadores
            allMarkers.forEach(m => map.removeLayer(m));
            allMarkers = [];
            // Agrega filtrados
            filtered.forEach(u => {
                const marker = L.marker([u.lat, u.lon], {icon: universityIcon})
                    .addTo(map)
                    .bindPopup(`
                        <strong>${u.name}</strong><br>
                        <em>${u['state-province'] ? u['state-province'] + ', ' : ''}MÃ©xico</em><br>
                        <a href="${u.web_pages[0]}" target="_blank" rel="noopener noreferrer">Sitio web</a>
                    `);
                allMarkers.push(marker);
            });
            if (filtered.length > 1) {
                const group = new L.featureGroup(allMarkers);
                map.fitBounds(group.getBounds().pad(0.08));
            } else if (filtered.length === 1) {
                map.setView([filtered[0].lat, filtered[0].lon], 14);
                allMarkers[0].openPopup();
            }
        }

        searchInput.addEventListener('input', e => filterAndShowMarkers(e.target.value));

        async function main() {
            loader.style.display = 'flex';
            let universidades = await fetchUniversitiesMX();

            // Carga las que ya tienen coordenadas en cachÃ©
            let cacheData = loadCache();
            let universidadesConCoords = cacheData.filter(u => u.lat && u.lon);
            allUniversities = [...universidadesConCoords];
            loader.style.display = 'none';
            filterAndShowMarkers('');

            // Geocodifica solo las que faltan
            let faltantes = universidades.filter(uni =>
                !cacheData.some(cu => cu.name === uni.name && cu.lat && cu.lon)
            );

            let cacheActualizado = [...cacheData];

            let count = 0;
            for (let uni of faltantes) {
                loader.style.display = 'flex';
                loader.innerText = `Geolocalizando: ${uni.name} (${++count}/${faltantes.length})`;

                let coords = await geocodeUniversity(uni);
                if (!coords) coords = await geocodeUniversity({name: uni.name});
                if (coords) {
                    let uniConCoords = {...uni, lat: coords.lat, lon: coords.lon};
                    allUniversities.push(uniConCoords);
                    cacheActualizado.push(uniConCoords);
                    filterAndShowMarkers(searchInput.value);
                    saveCache(cacheActualizado);
                }
                await sleep(1100);
            }
            loader.style.display = 'none';
        }
        main();
    </script>
</body>
</html>
