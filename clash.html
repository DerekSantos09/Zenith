<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Clash Royale Fusion - Ultra Épico</title>
<style>
body {
  margin: 0;
  background: linear-gradient(135deg, #3a7bd5 0%, #00d2ff 100%);
  font-family: 'Segoe UI', sans-serif;
  color: #fff;
  overflow-x: hidden;
}
#ui {
  display: flex;
  justify-content: center;
  align-items: center;
  margin: 18px 0 8px 0;
  gap: 20px;
  user-select: none;
}
.elixir-bar-bg {
  width: 220px;
  height: 32px;
  background: #223057;
  border-radius: 16px;
  border: 2.5px solid #6ef4ff;
  box-shadow: 0 2px 8px #0007;
  position: relative;
  overflow: hidden;
}
.elixir-bar-inner {
  position: absolute;
  left: 0; top: 0;
  height: 100%;
  background: linear-gradient(90deg, #6ef4ff 0%, #a66bff 100%);
  border-radius: 16px 0 0 16px;
  transition: width 0.4s cubic-bezier(.5,1.5,.5,1);
  box-shadow: 0 0 14px #fff7;
}
.elixir-label {
  position: absolute;
  width: 100%; text-align: center; top: 0;
  font-size: 18px; font-weight: bold;
  color: #213;
  text-shadow: 1px 1px 3px #fff8, 0 0 12px #fff6;
  line-height: 32px;
}
.unit-btn {
  background: linear-gradient(90deg, #ffd700 0%, #ff5e00 100%);
  color: #222;
  border: none;
  border-radius: 12px;
  font-size: 19px;
  padding: 11px 28px;
  margin: 0 6px;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 3px 10px #0004, 0 0 9px #ffdf;
  transition: transform 0.13s cubic-bezier(.7,1.7,.5,1), box-shadow .2s;
  letter-spacing: 0.5px;
}
.unit-btn:active, .unit-btn.seleccionada {
  transform: scale(0.95);
  box-shadow: 0 1px 5px #0008;
  outline: 3px solid #22f2ff;
}

#gameCanvas {
  display: block;
  margin: 0 auto;
  border-radius: 25px;
  border: 3.5px solid #224e7a;
  background: #a1ffce;
  box-shadow: 0 12px 40px #0f2940aa, 0 0 14px #ffffff40;
}
.status-panel {
  margin: 12px auto 0 auto;
  width: 410px;
  text-align: center;
  font-size: 20px;
  background: #213d5bdd;
  border-radius: 12px;
  box-shadow: 0 2px 12px #0007;
  padding: 8px 0;
  letter-spacing: 1px;
  position: relative;
  z-index: 2;
}
#elixirBarIA-bg {
  width: 220px;
  height: 23px;
  background: #223057;
  border-radius: 12px;
  border: 2px solid #f8baba;
  box-shadow: 0 2px 8px #0007;
  position: relative;
  overflow: hidden;
  margin-left: 18px;
  margin-top: 5px;
}
#elixirBarIA-inner {
  position: absolute;
  left: 0; top: 0;
  height: 100%;
  background: linear-gradient(90deg, #ffb9c3 0%, #ff8f8f 100%);
  border-radius: 12px 0 0 12px;
  transition: width 0.4s cubic-bezier(.5,1.5,.5,1);
  box-shadow: 0 0 9px #fff7;
}
#elixirBarIA-label {
  position: absolute;
  width: 100%; text-align: center; top: 0;
  font-size: 15px; font-weight: bold;
  color: #600;
  text-shadow: 1px 1px 3px #fff8, 0 0 12px #fff6;
  line-height: 23px;
}
#overlay {
  display: none;
  position: fixed;
  top:0; left:0; width:100vw; height:100vh;
  background: rgba(33,48,80,0.92);
  justify-content: center; align-items: center;
  z-index: 99;
  flex-direction: column;
}
#overlay h2 {
  font-size: 55px;
  margin: 0 0 18px 0;
  background: linear-gradient(90deg, #ffd700, #ff5e00, #ffd700);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-shadow: 0 4px 25px #fffb;
}
#overlay button {
  font-size: 28px;
  background: linear-gradient(90deg, #50f5a5, #3a7bd5 80%);
  border: none; border-radius: 10px;
  color: #fff;
  padding: 16px 44px;
  margin-top: 24px;
  font-weight: bold;
  box-shadow: 0 2px 18px #0006;
  cursor: pointer;
  transition: background 0.15s, transform 0.13s;
}
#overlay button:hover { background: linear-gradient(90deg, #3a7bd5, #50f5a5 80%); transform: scale(1.07); }
@media (max-width: 900px) {
  #gameCanvas { width: 98vw !important; height: 48vw !important; max-width: 700px; max-height: 350px;}
  .status-panel { width: 95vw; font-size: 17px;}
  #elixirBarIA-bg {width: 98vw !important;}
}
</style>
</head>
<body>
<h1 style="text-align:center;margin-top:20px;text-shadow:0 2px 14px #fff8,0 2px 30px #3a7bd5;">Clash Royale x Clash of Clans: Mini Fusión Épica</h1>
<div class="status-panel" id="statusPanel">
  <span id="vidaIzq">Vida Base Azul: 500</span>
  <span style="margin:0 18px;">|</span>
  <span id="vidaDer">Vida Base Roja: 500</span>
</div>
<div id="ui">
  <div>
    <div class="elixir-bar-bg">
      <div class="elixir-bar-inner" id="elixirBar"></div>
      <div class="elixir-label" id="elixirLabel">10 / 10</div>
    </div>
    <div id="elixirBarIA-bg">
      <div id="elixirBarIA-inner"></div>
      <div id="elixirBarIA-label">10 / 10</div>
    </div>
  </div>
  <button class="unit-btn" id="btn_tanque" onclick="seleccionarUnidad('tanque')">Tanque<br><small>4💧</small></button>
  <button class="unit-btn" id="btn_rapido" onclick="seleccionarUnidad('rapido')">Rápido<br><small>2💧</small></button>
  <button class="unit-btn" id="btn_magico" onclick="seleccionarUnidad('magico')">Mágico<br><small>3💧</small></button>
  <button class="unit-btn" id="btn_arquero" onclick="seleccionarUnidad('arquero')">Arquero<br><small>2💧</small></button>
  <button class="unit-btn" id="btn_gigante" onclick="seleccionarUnidad('gigante')">Gigante<br><small>6💧</small></button>
  <button class="unit-btn" id="btn_minipekka" onclick="seleccionarUnidad('minipekka')">Mini PEKKA<br><small>5💧</small></button>
</div>
<canvas id="gameCanvas" width="900" height="420"></canvas>

<div id="overlay">
  <h2 id="overlayTitle"></h2>
  <div id="overlayMsg"></div>
  <button onclick="restartGame()">¡Jugar de Nuevo!</button>
</div>

<script>
// --- Constantes de Arte y Colores ---
const COLORS = {
  fondo: ['#b0eaff','#b4ffb9'], // gradiente
  carriles: ['#a8e063','#56ab2f'],
  base_azul: '#3a7bd5',
  base_rojo: '#ff5e62',
  torre: ['#f7ff00','#db36a4'],
  barraVida: ['#00e1ff','#ff5e00'],
  vidaFondo: '#213d5b',
  tropa_azul: ['#7ed7ff','#3777ff'],
  tropa_roja: ['#ffb67e','#ff3a3a'],
  magico: ['#b164ff','#edb8ff'],
  rapido: ['#ffd700','#fffab7'],
  tanque: ['#b8b8b8','#575757'],
  arquero: ['#97edb8','#3ea75a'],
  gigante: ['#ffdeab','#e08a2e'],
  minipekka: ['#a6b8ff','#3c4b8a'],
  proyectil: ['#fff700','#ff3a3a','#00e1ff'],
  sombra: '#0005'
};
const NOMBRES = {
  tanque: 'Tanque',
  rapido: 'Rápido',
  magico: 'Mágico',
  arquero: 'Arquero',
  gigante: 'Gigante',
  minipekka: 'Mini PEKKA'
};

// --- Canvas y contexto ---
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

// --- Carriles ---
const carriles = [70, 170, 270];
const carrilH = 64;

// --- Bases y Torres ---
const baseIzq = {x:60,y:90,w:52,h:180,vida:500,vidaMax:500};
const baseDer = {x:canvas.width-112,y:90,w:52,h:180,vida:500,vidaMax:500};
const torresIzq = [{x:180,y:115,w:38,h:38,vida:130,ataque:16,rango:160,cd:0}];
const torresDer = [{x:canvas.width-218,y:115,w:38,h:38,vida:130,ataque:16,rango:160,cd:0}];

// --- Proyectiles y efectos ---
let proyectiles = [];
let efectos = [];

// --- Sistema de elixir (jugador y IA) ---
let elixirPlayer = 10, elixirPlayerMax = 10;
let elixirAI = 10, elixirAIMax = 10;
let elixirBar = document.getElementById('elixirBar');
let elixirLabel = document.getElementById('elixirLabel');
let elixirBarIA = document.getElementById('elixirBarIA-inner');
let elixirLabelIA = document.getElementById('elixirBarIA-label');

// Elixir jugador
setInterval(()=>{
  if(elixirPlayer < elixirPlayerMax) elixirPlayer++;
  updateElixirUI();
}, 1250);
// Elixir IA
setInterval(()=>{
  if(elixirAI < elixirAIMax) elixirAI++;
  updateElixirUI();
}, 1250);

function updateElixirUI() {
  let percent = (elixirPlayer/elixirPlayerMax);
  elixirBar.style.width = (percent*100)+"%";
  elixirLabel.textContent = elixirPlayer + " / " + elixirPlayerMax;
  elixirBar.style.background = percent === 1
    ? 'linear-gradient(90deg,#6ef4ff 0%,#ffd700 100%)'
    : 'linear-gradient(90deg,#6ef4ff 0%,#a66bff 100%)';

  // IA
  let percentAI = (elixirAI/elixirAIMax);
  elixirBarIA.style.width = (percentAI*100)+"%";
  elixirLabelIA.textContent = elixirAI + " / " + elixirAIMax;
  elixirBarIA.style.background = percentAI === 1
    ? 'linear-gradient(90deg,#ffb9c3 0%,#ffde84 100%)'
    : 'linear-gradient(90deg,#ffb9c3 0%,#ff8f8f 100%)';
}

// --- Sonidos (más cartoon) ---
const sonidos = {
  lanzar: new Audio("https://cdn.pixabay.com/audio/2022/07/26/audio_124bfa6f7e.mp3"),
  impacto: new Audio("https://cdn.pixabay.com/audio/2022/02/23/audio_115bfa6b7d.mp3"),
  explosion: new Audio("https://cdn.pixabay.com/audio/2022/10/16/audio_125bfa6f7e.mp3"),
  victoria: new Audio("https://cdn.pixabay.com/audio/2022/10/16/audio_125bfa6f7e.mp3"),
  derrota: new Audio("https://cdn.pixabay.com/audio/2022/07/26/audio_124bfa6f7e.mp3")
};

// --- Selección de unidad y despliegue con click ---
let unidadSeleccionada = null;
function seleccionarUnidad(tipo){
  if(unidadSeleccionada === tipo) {
    unidadSeleccionada = null;
    Array.from(document.getElementsByClassName('unit-btn')).forEach(b=>b.classList.remove('seleccionada'));
  } else {
    unidadSeleccionada = tipo;
    Array.from(document.getElementsByClassName('unit-btn')).forEach(b=>b.classList.remove('seleccionada'));
    document.getElementById('btn_'+tipo).classList.add('seleccionada');
  }
}
canvas.addEventListener('click', function(e){
  if(!unidadSeleccionada) return;
  let rect = canvas.getBoundingClientRect();
  let x = e.clientX - rect.left, y = e.clientY - rect.top;
  if(x > canvas.width/2 - 30) return; // solo tu lado (izquierda)
  lanzarUnidad(unidadSeleccionada, x, y, "izq");
  seleccionarUnidad(null);
});
function lanzarUnidad(tipo, x, y, side){
  const costos = { tanque:4, rapido:2, magico:3, arquero:2, gigante:6, minipekka:5 };
  let costo = costos[tipo]||3;
  if(side === "izq") {
    if(elixirPlayer < costo) {
      elixirBar.style.background = 'linear-gradient(90deg,#ff5e00 0%,#ffb700 100%)';
      setTimeout(updateElixirUI, 350);
      return;
    }
    elixirPlayer -= costo;
    updateElixirUI();
    sonidos.lanzar.currentTime=0; sonidos.lanzar.play();
  } else {
    if(elixirAI < costo) return;
    elixirAI -= costo;
    updateElixirUI();
  }
  // Normaliza Y a carril más cercano
  let minDist = 9999, bestY = carriles[0];
  for(let l of carriles) if(Math.abs(y-l)<minDist) { minDist=Math.abs(y-l); bestY=l; }
  // X por defecto para IA/jugador si no se da
  if(!x) x = (side=="izq"?130:canvas.width-130-38);
  tropas.push(new Unidad(x, bestY, tipo, side=="izq"?1:-1, side));
}

// --- Clase Unidad (ahora soporta más tipos) ---
class Unidad{
  constructor(x,y,tipo,direccion,side){
    this.x=x; this.y=y; this.tipo=tipo; this.direccion=direccion; this.side=side;
    // Stats por tipo
    if(tipo==='tanque'){this.vida=160; this.vidaMax=160; this.vel=0.6; this.atq=24; this.tam=44;}
    if(tipo==='rapido'){this.vida=80; this.vidaMax=80; this.vel=2.2; this.atq=12; this.tam=32;}
    if(tipo==='magico'){this.vida=85; this.vidaMax=85; this.vel=1.1; this.atq=29; this.tam=34;}
    if(tipo==='arquero'){this.vida=56; this.vidaMax=56; this.vel=1.3; this.atq=18; this.tam=28; this.rango=110;}
    if(tipo==='gigante'){this.vida=320; this.vidaMax=320; this.vel=0.5; this.atq=33; this.tam=54;}
    if(tipo==='minipekka'){this.vida=110; this.vidaMax=110; this.vel=1.7; this.atq=46; this.tam=34;}
    this.frame=0; this.frameMax=5;
    this.cd=0;
    this.dañoAnim=0;
  }
  mover(){ this.x += this.vel*this.direccion; }
  dibujar(){
    ctx.save();
    ctx.globalAlpha = 0.34;
    ctx.fillStyle = "#000";
    ctx.beginPath();
    ctx.ellipse(this.x+this.tam/2, this.y+this.tam-3, this.tam/2.2, 7, 0, 0, 2*Math.PI);
    ctx.fill();
    ctx.globalAlpha = 1;

    // Cuerpo principal (cartoon)
    let grad;
    if(this.tipo==="tanque"){
      grad = ctx.createLinearGradient(this.x,this.y,this.x+this.tam,this.y+this.tam);
      grad.addColorStop(0,COLORS.tanque[0]); grad.addColorStop(1,COLORS.tanque[1]);
      ctx.fillStyle = grad;
      ctx.fillRect(this.x, this.y, this.tam, this.tam-8);
      ctx.fillStyle = "#666";
      ctx.fillRect(this.x+7, this.y+this.tam-18, this.tam-14, 12);
      ctx.fillStyle = "#333";
      ctx.fillRect(this.x+this.tam/2-6, this.y+2, 12, this.tam-18);
    }
    if(this.tipo==="rapido"){
      grad = ctx.createLinearGradient(this.x,this.y,this.x+this.tam,this.y+this.tam);
      grad.addColorStop(0,COLORS.rapido[0]); grad.addColorStop(1,COLORS.rapido[1]);
      ctx.beginPath();
      ctx.ellipse(this.x+this.tam/2,this.y+this.tam/2,this.tam/2.1,this.tam/2.7,0,0,2*Math.PI); ctx.fillStyle=grad;
      ctx.fill();
      ctx.strokeStyle="#ffe";
      ctx.lineWidth=2; ctx.stroke();
      ctx.fillStyle = "#fff8";
      ctx.beginPath();
      ctx.ellipse(this.x+this.tam/2+4, this.y+this.tam/2-7, 7, 4, 0, 0, 2*Math.PI); ctx.fill();
    }
    if(this.tipo==="magico"){
      grad = ctx.createLinearGradient(this.x,this.y,this.x+this.tam,this.y+this.tam);
      grad.addColorStop(0,COLORS.magico[0]); grad.addColorStop(1,COLORS.magico[1]);
      ctx.beginPath();
      ctx.arc(this.x+this.tam/2,this.y+this.tam/2,this.tam/2,0,2*Math.PI); ctx.fillStyle=grad;
      ctx.shadowColor="#fff6"; ctx.shadowBlur=18; ctx.fill();
      ctx.shadowBlur=0;
      ctx.fillStyle="#fff";
      ctx.font="bold 17px Segoe UI";
      ctx.globalAlpha=0.33; ctx.fillText("★",this.x+this.tam/2-8,this.y+this.tam/2+6);
      ctx.globalAlpha=1;
    }
    if(this.tipo==="arquero"){
      grad = ctx.createLinearGradient(this.x,this.y,this.x+this.tam,this.y+this.tam);
      grad.addColorStop(0,COLORS.arquero[0]); grad.addColorStop(1,COLORS.arquero[1]);
      ctx.fillStyle=grad;
      ctx.beginPath();ctx.arc(this.x+this.tam/2,this.y+this.tam/2,this.tam/2,0,2*Math.PI);ctx.fill();
      ctx.fillStyle="#333a";
      ctx.fillRect(this.x+this.tam/2-3,this.y+this.tam/2,6,this.tam/2);
    }
    if(this.tipo==="gigante"){
      grad = ctx.createLinearGradient(this.x,this.y,this.x+this.tam,this.y+this.tam);
      grad.addColorStop(0,COLORS.gigante[0]); grad.addColorStop(1,COLORS.gigante[1]);
      ctx.fillStyle=grad;
      ctx.fillRect(this.x, this.y, this.tam, this.tam-8);
      ctx.fillStyle="#a67b4a";
      ctx.fillRect(this.x+this.tam/2-7, this.y+8, 14, this.tam-22);
      ctx.strokeStyle="#e08a2e"; ctx.lineWidth=2;
      ctx.strokeRect(this.x+2,this.y+4,this.tam-4,this.tam-16);
    }
    if(this.tipo==="minipekka"){
      grad = ctx.createLinearGradient(this.x,this.y,this.x+this.tam,this.y+this.tam);
      grad.addColorStop(0,COLORS.minipekka[0]); grad.addColorStop(1,COLORS.minipekka[1]);
      ctx.fillStyle=grad;
      ctx.beginPath(); ctx.arc(this.x+this.tam/2,this.y+this.tam/2,this.tam/2,0,2*Math.PI); ctx.fill();
      ctx.fillStyle="#fff";
      ctx.fillRect(this.x+this.tam/2-4,this.y+this.tam/2-2,8,10);
    }
    // Animación de daño (blink)
    if(this.dañoAnim>0){
      ctx.globalAlpha = Math.max(0, this.dañoAnim/10);
      ctx.fillStyle = "#fff";
      ctx.fillRect(this.x-2,this.y-2,this.tam+4,this.tam+4);
      ctx.globalAlpha = 1;
      this.dañoAnim--;
    }
    // Barra de vida
    ctx.save();
    ctx.fillStyle = COLORS.vidaFondo;
    ctx.fillRect(this.x-1, this.y-13, this.tam+2, 8);
    let gradBar = ctx.createLinearGradient(this.x, 0, this.x+this.tam, 0);
    gradBar.addColorStop(0, COLORS.barraVida[0]);
    gradBar.addColorStop(1, COLORS.barraVida[1]);
    ctx.fillStyle = gradBar;
    ctx.fillRect(this.x, this.y-12, this.tam*(this.vida/this.vidaMax), 6);
    ctx.restore();

    // Nombre
    ctx.save();
    ctx.font = "bold 13px Segoe UI";
    ctx.fillStyle = this.side==="izq"? "#2af" : "#f23";
    ctx.shadowColor="#fff6"; ctx.shadowBlur=3;
    ctx.textAlign="center";
    ctx.fillText(NOMBRES[this.tipo], this.x+this.tam/2, this.y-18);
    ctx.restore();

    ctx.restore();
    this.frame=(this.frame+0.2)%this.frameMax;
  }
}

// --- Clase Proyectil ---
class Proyectil{
  constructor(x,y,target,daño,color){
    this.x=x; this.y=y; this.target=target; this.daño=daño; this.color=color; this.vel=6;
    this.tam = 8 + Math.random()*3;
  }
  mover(){
    const dx=this.target.x+this.target.tam/2-this.x,dy=this.target.y+this.target.tam/2-this.y,dist=Math.hypot(dx,dy);
    if(dist<this.vel){
      this.target.vida-=this.daño;
      this.target.dañoAnim = 7;
      efectos.push(new Efecto(this.target.x+this.target.tam/2,this.target.y+this.target.tam/2,17,15,true));
      sonidos.impacto.currentTime=0; sonidos.impacto.play();
      return false;
    }
    this.x+=dx/dist*this.vel; this.y+=dy/dist*this.vel; return true;
  }
  dibujar(){
    ctx.save();
    ctx.shadowColor = "#fff";
    ctx.shadowBlur = 8;
    ctx.fillStyle=this.color;
    ctx.beginPath(); ctx.arc(this.x,this.y,this.tam,0,Math.PI*2); ctx.fill();
    ctx.shadowBlur = 0;
    ctx.restore();
  }
}

// --- Efecto explosiones y partículas ---
class Efecto{
  constructor(x,y,r,t,explosion=false){
    this.x=x; this.y=y; this.r=r; this.t=t; this.explosion=explosion;
    if(explosion){ sonidos.explosion.currentTime=0; sonidos.explosion.play(); }
  }
  dibujar(){
    ctx.save();
    ctx.strokeStyle=this.explosion?'#ffbc00':'#fff';
    ctx.lineWidth = this.explosion ? 5 : 2;
    ctx.globalAlpha = Math.max(0, this.t/30);
    ctx.beginPath(); ctx.arc(this.x,this.y,this.r,0,Math.PI*2); ctx.stroke();
    ctx.restore();
    this.r+=2; this.t--;
  }
}

// --- Tropas ---
let tropas=[];

// --- Lanzar unidad IA ---
function lanzarUnidadIA(){
  if(baseDer.vida<=0) return;
  // Decide tipo y costo
  let tipos = ['tanque','rapido','magico','arquero','gigante','minipekka'];
  let tipo = tipos[Math.floor(Math.random()*tipos.length)];
  const costos = { tanque:4, rapido:2, magico:3, arquero:2, gigante:6, minipekka:5 };
  let costo = costos[tipo]||3;
  if(elixirAI < costo) return;
  // Carril random, x random pero solo en su mitad
  const carrilY = carriles[Math.floor(Math.random()*carriles.length)];
  let x = canvas.width - 130 - Math.random()*40;
  lanzarUnidad(tipo, x, carrilY, "der");
}

// --- Función batalla principal ---
function battle(){
  tropas.forEach((u,i)=>{
    if(u.cd>0) u.cd--;
    u.mover();
    // Ataca base
    const baseTarget = u.direccion===1?baseDer:baseIzq;
    if(u.x+u.tam>=baseTarget.x && u.x<=baseTarget.x+baseTarget.w && u.y+u.tam>=baseTarget.y && u.y<=baseTarget.y+baseTarget.h){
      baseTarget.vida-=u.atq;
      efectos.push(new Efecto(baseTarget.x+baseTarget.w/2,baseTarget.y+baseTarget.h/2,24,25,true));
      u.vida=0;
      baseTarget.vida = Math.max(0, baseTarget.vida);
      updateStatusPanel();
    }
    // Ataca tropas del lado opuesto
    tropas.forEach((v,j)=>{
      if(i===j) return;
      if(u.direccion!==v.direccion && Math.abs(u.x-v.x)<32 && Math.abs(u.y-v.y)<carrilH/2){
        if(u.tipo==='magico' && u.cd<=0){
          proyectiles.push(new Proyectil(u.x+u.tam/2,u.y+u.tam/2,v,u.atq,'#30d0ff'));
          u.cd=25+Math.floor(Math.random()*6);
        }
        else if(u.tipo==='arquero' && u.cd<=0){
          proyectiles.push(new Proyectil(u.x+u.tam/2,u.y+u.tam/2,v,u.atq,'#41e171'));
          u.cd=22+Math.floor(Math.random()*8);
        }
        else if(u.cd<=0){
          v.vida-=u.atq; u.vida-=v.atq;
          v.dañoAnim = 5; u.dañoAnim = 5;
          efectos.push(new Efecto(u.x+u.tam/2,u.y+u.tam/2,14,12,true));
          u.cd=18+Math.floor(Math.random()*4);
          v.cd=18+Math.floor(Math.random()*4);
        }
      }
      // Rango arquero
      if(u.tipo==='arquero' && Math.abs(u.x-v.x)<u.rango && Math.abs(u.y-v.y)<carrilH/2 && u.side!=="der" && u.cd<=0){
        proyectiles.push(new Proyectil(u.x+u.tam/2,u.y+u.tam/2,v,u.atq,'#41e171'));
        u.cd=22+Math.floor(Math.random()*8);
      }
    });
  });

  // Torres
  [...torresIzq, ...torresDer].forEach((t,idx)=>{
    if(t.cd>0) t.cd--;
    tropas.forEach(u=>{
      if( (idx===0 && u.direccion===-1) || (idx===1 && u.direccion===1) ){
        if(Math.hypot(u.x+u.tam/2-t.x-t.w/2, u.y+u.tam/2-t.y-t.h/2)<t.rango && t.cd<=0){
          if(u.tipo==='magico'){
            proyectiles.push(new Proyectil(t.x+t.w/2,t.y+t.h/2,u,t.ataque,'#ffbc00'));
          } else {
            u.vida-=t.ataque; u.dañoAnim = 4;
            efectos.push(new Efecto(u.x+u.tam/2,u.y+u.tam/2,12,8,true));
          }
          t.cd=28+Math.floor(Math.random()*6);
        }
      }
    });
  });

  proyectiles = proyectiles.filter(p=>p.mover());
  tropas = tropas.filter(u=>u.vida>0);
  efectos = efectos.filter(e=>{e.dibujar(); return e.t>0;});
}

// --- Dibujar todo ---
function draw(){
  // Fondo colorido
  let bgGrad = ctx.createLinearGradient(0,0,canvas.width,canvas.height);
  bgGrad.addColorStop(0,COLORS.fondo[0]);
  bgGrad.addColorStop(1,COLORS.fondo[1]);
  ctx.fillStyle = bgGrad;
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // Carriles
  for(let i=0; i<carriles.length; i++){
    let grad = ctx.createLinearGradient(0,0,canvas.width,0);
    grad.addColorStop(0,COLORS.carriles[0]);
    grad.addColorStop(1,COLORS.carriles[1]);
    ctx.fillStyle = grad;
    ctx.fillRect(0, carriles[i], canvas.width, carrilH-14);
    ctx.save();
    ctx.globalAlpha = 0.18;
    ctx.fillStyle = "#000";
    ctx.fillRect(0, carriles[i]+carrilH-14, canvas.width, 6);
    ctx.restore();
  }

  // Bases
  drawBase(baseIzq.x, baseIzq.y, baseIzq.w, baseIzq.h, COLORS.base_azul, "izq");
  drawBase(baseDer.x, baseDer.y, baseDer.w, baseDer.h, COLORS.base_rojo, "der");

  // Vida bases
  drawBarraVida(baseIzq.x, baseIzq.y-19, baseIzq.w, 10, baseIzq.vida, baseIzq.vidaMax, "#3a7bd5");
  drawBarraVida(baseDer.x, baseDer.y-19, baseDer.w, 10, baseDer.vida, baseDer.vidaMax, "#ff5e62");

  // Torres
  torresIzq.forEach(t=>drawTorre(t.x,t.y,t.w,t.h,"#69f"));
  torresDer.forEach(t=>drawTorre(t.x,t.y,t.w,t.h,"#f23"));

  // Tropas
  tropas.forEach(u=>u.dibujar());
  // Proyectiles
  proyectiles.forEach(p=>p.dibujar());
  // Efectos
  efectos.forEach(e=>e.dibujar());
}

// --- Barra de vida ---
function drawBarraVida(x, y, w, h, vida, vidaMax, color){
  ctx.save();
  ctx.fillStyle = "#222c";
  ctx.fillRect(x, y, w, h);
  let grad = ctx.createLinearGradient(x, y, x+w, y);
  grad.addColorStop(0, color);
  grad.addColorStop(1, "#fff");
  ctx.fillStyle = grad;
  ctx.fillRect(x, y, w*(vida/vidaMax), h);
  ctx.strokeStyle="#fff8";
  ctx.strokeRect(x, y, w, h);
  ctx.restore();
}

// --- Torre cartoon ---
function drawTorre(x, y, w, h, color){
  ctx.save();
  ctx.fillStyle = color;
  ctx.beginPath();
  ctx.moveTo(x+w/2, y);
  ctx.lineTo(x+w, y+h/3);
  ctx.lineTo(x+w, y+h);
  ctx.lineTo(x, y+h);
  ctx.lineTo(x, y+h/3);
  ctx.closePath();
  ctx.shadowColor = "#fff8";
  ctx.shadowBlur=10;
  ctx.fill();
  ctx.shadowBlur=0;
  // Ventana
  ctx.fillStyle="#fff";
  ctx.fillRect(x+w/2-7, y+h-18, 14, 14);
  ctx.restore();
}

// --- Panel de vida y estado ---
function updateStatusPanel(){
  document.getElementById('vidaIzq').textContent = `Vida Base Azul: ${Math.max(0,baseIzq.vida)}`;
  document.getElementById('vidaDer').textContent = `Vida Base Roja: ${Math.max(0,baseDer.vida)}`;
}

// --- Overlay de victoria/derrota ---
function showOverlay(title,msg,victory){
  let overlay = document.getElementById("overlay");
  document.getElementById("overlayTitle").textContent = title;
  document.getElementById("overlayMsg").innerHTML = msg;
  overlay.style.display = "flex";
  if(victory) { sonidos.victoria.currentTime=0; sonidos.victoria.play(); }
  else { sonidos.derrota.currentTime=0.3; sonidos.derrota.play(); }
}
function hideOverlay(){
  document.getElementById("overlay").style.display = "none";
}

// --- Reiniciar juego ---
function restartGame(){
  baseIzq.vida = baseIzq.vidaMax;
  baseDer.vida = baseDer.vidaMax;
  tropas = []; proyectiles = []; efectos = [];
  elixirPlayer = elixirPlayerMax;
  elixirAI = elixirAIMax;
  updateElixirUI();
  updateStatusPanel();
  hideOverlay();
  setTimeout(gameLoop, 100);
}

// --- Loop principal ---
let gameEnded = false;
function gameLoop(){
  if(baseIzq.vida<=0){
    showOverlay("DERROTA", "<span style='font-size:1.3em;'>¡La base azul ha caído!</span>", false);
    gameEnded = true; return;
  }
  if(baseDer.vida<=0){
    showOverlay("¡VICTORIA!", "<span style='font-size:1.3em;'>¡Ganaste! La base roja ha caído</span>", true);
    gameEnded = true; return;
  }
  gameEnded = false;
  battle();
  draw();
  // IA lanza tropas random cada 2.5~4.1s si tiene elixir suficiente
  if(Math.random()<0.015 && elixirAI>=2) lanzarUnidadIA();
  requestAnimationFrame(gameLoop);
}
updateStatusPanel();
updateElixirUI();
gameLoop();

</script>
</body>
</html>
